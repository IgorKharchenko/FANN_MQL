# Входные параметры
_Входные данные:_

* __Таймфрейм__ — таймфрейм, на котором будет запущен советник. По умолчанию указан текущий период.
* __Источник входных данных: цены открытия/закрытия, SMA/EMA__ — источник входных данных для сети. 
На данный момент предусмотрено 4 источника:
  - DATA_SOURCE_OPEN — цены открытия бара,
  - DATA_SOURCE_CLOSE — цены закрытия бара,
  - DATA_SOURCE_SMA — данные индикатора SMA,
  - DATA_SOURCE_EMA — данные индикатора EMA,

_Параметры нейронной сети:_ 
* __Диапазон генерации начальных рандомных коэффициентов__ — генерация начальных весовых коэффициентов нейросети происходит в небольшом диапазоне чисел. 
Данный параметр является нетривиальным для трейдера, но он играет ключевую роль в скорости сходимости среднеквадратической ошибки (далее СКО) сети.
На данный момент предусмотрено два типа:
    - *COEFF_FROM_MINUS_1_TO_1* — диапазон [-1; 1].
    - *COEFF_MARIUSZ_WOLOSZYN* — диапазон [-0.4; 0.4]. 
    Автор библиотеки FANN Мариуш Волошин написал статью, в которой описал торгового советника, который использует данный диапазон генерации весовых коэффициентов.
    Подробнее по [ссылке](https://www.mql5.com/ru/articles/1565).
* __Количество входных нейронов__ — количество нейронов во входном слое нейросети. Совпадает с размером окна обучения нейросети.
* __Количество скрытых нейронов__ — количество нейронов в двух скрытых слоях нейросети.
* __Количество выходных нейронов__ — количество нейронов в выходном слое нейросети. Этот слой при работе сети проверяется на соответствие с реальными данными.  

_Параметры сбора статистики работы нейросети._   
Подробнее о статистике в главе "Сбор статистики".
* __Схоронять ли среднеквадратическую ошибку сети в файл__ — будет ли схороняться ошибка сети в файл `Neuro_MSE.csv`.
* __Схоронять ли результат работы сети в файл__ — будет ли схороняться ошибка сети в файл `Neuro_Results.csv`.
* __Схоронять ли статистику правильных ответов сети в файл__ — будет ли схороняться ошибка сети в файл `Neuro_RightAnswersStats.csv`.
* __Показывать ли статистику правильных ответов сети__ — будет ли показываться статистика правильных ответов сети в блоке "Эксперты" в торговом терминале. 
Если `true`, то на 100, 1000, 1500, 2000 и 2500 шагах работы (не обучения) будет выводиться статистика правильно предсказанных сетью направлений движений.
Сделано это с целью отследить правильность прогноза на разных шагах.

_Параметры входных данных для сети_:
* __Количество баров, которое будет обработано сетью при тренировке__ — количество баров, которое будет обработано на каждой эпохе обучения.
* __Количество баров, которое будет обработано сетью при запуске__ — количество баров, которое будет использовано при запуске сети на исторических данных.
* __Размер окна для обучения и работы ИНС__ — на данный момент не является входным параметром, так как размер окна обучения равен количеству входных нейронов сети.
* __Количество эпох, т.е. полных переборов тренировочных сетов__ — под тренировочными сетами подразумевается один полный перебор всех доступных цен из массива OHLCT.

_Параметры тренировки сети_:
* __Ошибка ИНС__ — если был выбран алгоритм _TRAIN_UNTIL_MSE_REACHES_EPSILON_, то сеть будет тренироваться до тех пор, пока СКО не будет меньше этого параметра; иначе данный параметр игнорируется.
* __Сколько ИНС тренируется: пока есть эпохи/пока ошибка > AnnEps__ — как долго нейросеть будет тренироваться.
На данный момент существует два режима тренировки ИНС:
    - _TRAIN_UNTIL_EPOCHS_ – тренироваться заданное количество эпох (см. параметр __Количество эпох__),
    - _TRAIN_UNTIL_MSE_REACHES_EPSILON_ — тренироваться, пока СКО сети не станет меньше параметра __Ошибка ИНС__. 
    Если выбран данный режим обучения, то параметр __Количество эпох__ игнорируется.
* __Показывать ли сообщение о том, что MSE резко пошла вверх__ — показывать ли все сообщения о флуктуациях СКО сети. Подробнее о флуктуациях см. главу "Предсказание ИНС", подглава "Флуктуации ИНС".
* __Алгоритм проверки ответа ИНС__ — см. главу "Предсказание ИНС", подглаву "Алгоритм проверки ответа ИНС".

_Параметры советника_:
* __Уровень отображаемых сообщений__ — уровень сообщений, которые выводятся в меню "Эксперт" торгового терминала.  
Всего их 4:
   - NOTHING – не отображать ___ничего___ (даже критические ошибки),
   - ERROR – отображать ___только критические ошибки___,
   - WARNING — отображать помимо критических ошибок ___ещё и предупреждения___,
   - INFORMATION — отображать помимо того, что выше, ___ещё и информационные сообщения___.

# Сбор статистики

## Файлы со статистикой
По умолчанию вся статистика собирается в папке `Data`, которая находится в директории `MQL4\Files`.  
Файлы со статистикой схороняются с расширением .csv.  
На данный момент есть 4 файла со статистикой:
- __Neuro_MSE.csv__ — файл со статистикой среднестатистической ошибки (далее СКО) сети.
- __Neuro_Results.csv__ — файл со статистикой выходного слоя ИНС при работе сети.
- __Neuro_CommonStats.csv__ — файл с общей статистикой работы ИНС. 
Схороняется статистика по следующим параметрам:
    - общему количеству эпох, 
    - СКО в конце обучения,  
    - общему количеству флуктуаций СКО.  
- __Neuro_RightAnswersStats.csv__ — файл со статистикой угадывания ответов ИНС.
Ответы хранятся в дробном формате. 
Подробее см. главу "Предсказание ИНС".

## Скрипт для конвертации точек в запятые
Данный костыль конвертирует все точки в файлах в запятые, потому что excel распознаёт дробные числа, записанные через точку, не как числа, а как строки.  
Признаю, что есть более простой способ преобразования в самОм excel, но мне лично на этапе разработки и тестирования было проще запустить скрипт из консоли, нежели нажимать кнопки в excel.  
Так что оставил его на память.
Написан на `php` версии 5.6.  
Запустить скрипт:
```
php.exe convert_dots_to_commas.php --convert-all
```
После названия файла следуют параметры запуска, записываемые через `--`.
Параметры:
- `convert-all` — конвертировать все 4 файла.
- `with-mse` — конвертировать файл с СКО.
- `with-results` — конвертировать файл с результатами работы ИНС (т.е. её выходной слой).
- `with-right-answers-stat` — конвертировать файл со статистикой правильных ответов сети.
- `with-common-stat` — конвертировать файл с общей статистикой работы сети.

Можно объединять параметры.  
К примеру, запуск данного сочетания:
```
php.exe convert_dots_to_commas.php --with-mse --with-common-stat
```
конвертирует все точки в запятые в файлах __Neuro_MSE.csv__ и __Neuro_CommonStats.csv__.  

# Предсказание ~~Нострадамуса~~ ИНС

## Каким образом человек думает, как происходит предсказание

Оборудование:
1. Турка для варки кофе
2. Кофе молотый, 1 чайная ложка.
3. Вода питьевая дистиллированная, 200 мл.
4. Кофейная чашка объёмом 250 мл.
5. Монета
6. Торговый терминал _MetaTrader_ версии 5.0

Ход работы:
1. Налить вскипяченную воду в турку, добавить туда кофе
2. После того. как кофе в турке вскипятится, налить кофе в кофейную чашку
3. Выпить кофе
4. Открыть терминал _MetaTrader_ и запустить советника _Fann-Expert_
5. Приступить к гаданию, как рассказано  [на данной странице](http://www.astromeridian.ru/gadanie_na_kofejnoj_guwe.php)
6. Кинуть монету из расчёта орёл – да, решка – нет
7. Проверить результат, выданный советником из п. 4 с результатами в п.5 и п.6

## Как реально происходит предсказание

Конфигурация сети следующая:
- 1 входной слой,
- 2 скрытых слоя,
- 1 выходной слой.

Существует т.н. *окно обучения* нейросети, которое равно количеству нейронов во входном слое.  
На графике 1 демонстрируется, каким образом происходит обучение нейронной сети.

![Как работает нейросеть](https://a.radikal.ru/a21/1804/b8/4bfac40e177a.png)
График 1 — Как работает нейронная сеть
Все значения из окна проходят во входной слой ИНС. Далее сеть выдаёт результат, который сравнивается со значениями, находящимися за окном (т.е. справа).  
Статистика совпадений результатов записывается в файл __Neuro_Results.csv__.  
После проверки результатов окно сдвигается справо на 1 бар (график 2).
![Сдвиг окна на один бар](https://a.radikal.ru/a03/1804/38/389b4337b7e6.png)
График 2 — Сдвиг окна на один бар

## Флуктуации ИНС

В ходе работы сети её СКО при обучении должна стремиться к нулю.  
Однако в какой–то момент времени ошибка может резко подскочить вверх, как показано на графике 3.

![Флуктуация СКО сети](https://a.radikal.ru/a19/1804/35/5134a0b83f72.png)
График 3 — Флуктуация среднеквадратической ошибки сети

На графике видно, как после 171 шага СКО внезапно подскочила вверх, после чего некоторое время имела тенденцию к росту. Однако на 211 шаге она опять пошла вниз.  
В идеале не должно быть ни одной флуктуации.  
Если есть флуктуации, это сигнализирует о неправильно подобранных параметрах.

## Алгоритм проверки ответа ИНС

Есть один основной алгоритм проверки правильности ответа сети.
Он основывается на угадывании направления движения рынка.  
Данный алгоритм представлен на графике 4, п. 2.
1. Циклом пробегаемся по всему выходному слою сети.
2. На каждом шаге вычисляется спред выходного слоя ИНС и реальных данных.
3. Если оба спреда отрицательные или оба положительные, то ответ верен; иначе неверен.

Также мною высказан ещё один алгоритм, представленный на графике 4, п. 1.  
Он основан на вычислении расхождений между ожидаемыми значениями и результатом работы сети.
Данный метод предполагает, что есть некое значение ε, подбираемое самостоятельно. 
1. На каждом шаге цикла рассчитывается _abs(Close~i~ - ВыходСети~i~)_. 
2. Если последнее больше ε, то делаем вывод о том, что ИНС ошиблась; если меньше, то делаем вывод о том, что сеть дала правильный результат.

Данный метод имеет место быть, но нужно грамотно подбирать значение ε.
Есть также ещё один метод, основанный на методе расхождений между значениями.  
Он предполагает, что расхождения будут вычисляться не между самими значениями, а между их спредами.

![Алгоритмы проверки правильности работы сети](https://d.radikal.ru/d37/1804/02/fd84165e9f47.png)
График 4 — Алгоритмы проверки правильности работы сети

Советник поддерживает следующие методы:
* ALG_TREND_DIRECTION — сравнение направлений движения результата сети и реальных данных,
* ALG_DIVERGENCE_BETWEEN_POINTS — сравнение расхождений результата сети и реальных данных,
* ALG_DIVERGENCE_BETWEEN_SPREADS — сравнение расхождений спредов результата сети и реальных данных.
